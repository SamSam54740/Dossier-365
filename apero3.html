<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <title>PHASE 3 : L'ENQU√äTE DU SAINT FOY'S</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Caveat:wght@400;700&family=Montserrat:wght@300;600;900&family=Share+Tech+Mono&family=Reenie+Beanie&display=swap" rel="stylesheet">

    <style>
        /* ================================= VARIABLES ================================= */
        :root {
            --bg-color: #050505;
            --wood-texture: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            --paper-texture: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            --cardboard-texture: url('https://www.transparenttextures.com/patterns/cardboard.png');
            --ink-black: #1a1a1a;
            --ink-blue: #1a237e;
            --accent-gold: #ffc107;
            --accent-uv: #6200ea;
            --text-uv: rgba(100, 255, 50, 0.95);
            --font-ui: 'Montserrat', sans-serif;
            --font-type: 'Special Elite', monospace;
            --font-hand: 'Caveat', cursive;
            --font-messy: 'Reenie Beanie', cursive;
            --font-tech: 'Share Tech Mono', monospace;
        }

        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #050505; overflow: hidden; font-family: var(--font-ui); color: white; }

        /* ================================= ENVIRONNEMENT ================================= */
        #game-stage {
            position: relative; width: 100%; height: 100%;
            background-color: #2e1a0f; background-image: var(--wood-texture);
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
            /* Important : On laisse les events passer */
        }
        #stage-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.5) 100%); 
            pointer-events: none;
        }

        /* ================================= ITEMS ================================= */
        .table-item {
            position: absolute; cursor: pointer; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));
            /* Transition l√©g√®re au survol/clic, mais PAS sur le drag */
            transition: transform 0.1s, filter 0.1s; 
            transform-origin: center; will-change: left, top; z-index: 10;
        }
        .table-item:active { filter: drop-shadow(0 5px 15px rgba(0,0,0,0.6)); }

        /* --- COFFRE (Style) --- */
        #item-safe {
            width: 140px; height: 110px; 
            perspective: 1000px;
            z-index: 100;
            /* CRUCIAL : D√©sactive le scroll natif du navigateur sur cet objet */
            touch-action: none; 
        }
        
        .safe-body {
            width: 100%; height: 100%;
            background: linear-gradient(180deg, #444, #222);
            border: 2px solid #111; border-radius: 6px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.9);
            position: relative; transform-style: preserve-3d;
        }
        .safe-interior {
            position: absolute; top: 5%; left: 5%; width: 90%; height: 90%;
            background: #000; box-shadow: inset 0 0 15px #000;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .safe-bottle {
            font-size: 3.5rem; filter: drop-shadow(0 0 20px gold);
            opacity: 0; transform: scale(0.5); transition: all 1s ease-out 0.5s;
        }
        #item-safe.open-anim .safe-bottle { opacity: 1; transform: scale(1); }

        .safe-door {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #3a3a3a, #1a1a1a);
            border: 1px solid #555; border-radius: 4px;
            transform-origin: left; transition: transform 2s ease-in-out;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backface-visibility: hidden;
        }
        #item-safe.open-anim .safe-door { transform: rotateY(-140deg); }
        /* Elements Porte */
        .safe-dial { width: 45px; height: 45px; background: #111; border-radius: 50%; border: 2px solid #666; box-shadow: 0 3px 6px black; margin-bottom: 8px; position:relative;}
        .safe-dial::before { content: ''; position: absolute; top: 2px; left: 50%; transform: translateX(-50%); width: 2px; height: 8px; background: red; }
        .safe-handle { width: 35px; height: 6px; background: #ccc; border-radius: 4px; box-shadow: 0 2px 3px black; }

        /* Animation finale de centrage */
        #item-safe.move-center {
            transition: all 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) scale(1.5) !important;
            z-index: 15000 !important;
        }

        /* --- AUTRES ITEMS --- */
        #item-flashlight {
            width: 110px; height: 35px; background: #111; border-radius: 10px; border: 1px solid #333;
            z-index: 5; display: flex; align-items: center; justify-content: space-between; padding: 0 4px;
            box-shadow: inset 0 0 8px black; pointer-events: auto;
        }
        /* Hitbox invisible g√©ante pour la lampe */
        #item-flashlight::after { content: ''; position: absolute; top: -10px; bottom: -10px; left: -10px; right: -10px; }
        .flash-head { width: 20px; height: 34px; background: #222; border-right: 2px solid #444; border-radius: 3px; }
        .flash-body { width: 60px; height: 18px; background: repeating-linear-gradient(90deg, #111, #111 2px, #222 2px, #222 4px); }

        /* --- LETTRE --- */
        .item-letter {
            width: 150px; height: 100px; background: #fff; background-image: var(--paper-texture);
            padding: 10px; color: #111; transform: rotate(3deg); box-shadow: 0 2px 5px rgba(0,0,0,0.3); overflow: hidden;
        }
        .letter-blur { 
            font-family: var(--font-messy); font-size: 0.5rem; line-height: 0.9; 
            color: #444; filter: blur(0.6px); opacity: 0.8; 
            user-select: none; pointer-events: none; white-space: wrap; 
        }

        /* --- TICKET --- */
        .item-receipt {
            width: 100px; height: 190px; background: #fff; padding: 8px; font-family: var(--font-tech);
            font-size: 0.45rem; color: #333; transform: rotate(-5deg);
            background-image: linear-gradient(to bottom, transparent, rgba(0,0,0,0.02));
            mask-image: linear-gradient(to bottom, transparent 1%, black 2%, black 98%, transparent 99%);
            border-top: 1px dotted #ccc; border-bottom: 1px dotted #ccc;
        }
        .receipt-header { text-align: center; margin-bottom: 8px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 2px;}
        .receipt-total { margin-top: 10px; border-top: 2px dashed #000; padding-top: 4px; font-weight: bold; font-size: 0.55rem; display: flex; justify-content: space-between; }
        .hidden-price { background: #111; color: #111; padding: 0 2px; }
        .receipt-stain { position: absolute; bottom: 30px; left: 10px; width: 30px; height: 30px; background: rgba(160, 100, 30, 0.2); border-radius: 50%; filter: blur(5px); pointer-events: none; }

        /* --- MENU --- */
        .item-menu {
            width: 130px; height: 190px; background: #1b1b1b; border: 2px solid var(--accent-gold);
            color: #ddd; padding: 10px; font-family: 'Times New Roman', serif; transform: rotate(-3deg);
            box-shadow: 0 5px 12px rgba(0,0,0,0.6);
        }
        .menu-title { text-align: center; font-family: var(--font-ui); font-weight:900; color: var(--accent-gold); margin-bottom: 10px; padding-bottom: 4px; border-bottom: 1px solid #444; letter-spacing: 1px; font-size: 0.8rem; }
        .menu-list { font-size: 0.55rem; line-height: 1.8; }
        .menu-item { display: flex; justify-content: space-between; border-bottom: 1px dotted #444; }

        /* --- POLAROID --- */
        .item-photo { width: 110px; height: 140px; background: #fff; padding: 6px 6px 30px 6px; transform: rotate(8deg); box-shadow: 0 3px 8px rgba(0,0,0,0.4); }
        .photo-inner { width: 100%; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .photo-inner img { width: 100%; height: 100%; object-fit: cover; filter: contrast(1.1) sepia(0.2); }
        .photo-text { position: absolute; bottom: 6px; width: 100%; text-align: center; font-family: var(--font-hand); color: #222; font-weight: bold; font-size: 0.9rem; }

        /* --- SOUS-BOCK --- */
        .item-coaster {
            width: 90px; height: 90px; border-radius: 50%; background: #d7ccc8;
            border: 3px solid #5d4037; display: flex; align-items: center; justify-content: center; text-align: center;
            transform: rotate(20deg); padding: 5px; background-image: var(--cardboard-texture); box-shadow: 0 3px 6px rgba(0,0,0,0.5);
        }
        .coaster-logo { font-family: var(--font-type); color: #3e2723; font-weight: bold; line-height: 1.1; font-size: 0.7rem; }

        /* ================================= LUMI√àRE & UV ================================= */
        .uv-hidden-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.1s; pointer-events: none; display: flex; align-items: center; justify-content: center; }
        .uv-text-style { font-family: var(--font-hand); font-weight: bold; color: var(--text-uv); text-shadow: 0 0 5px var(--text-uv); text-align: center; }
        .uv-revealable.is-lit .uv-hidden-layer { opacity: 1; }

        #light-mask-normal, #light-mask-uv { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none !important; opacity: 0; transition: opacity 0.2s; will-change: opacity; }
        #light-mask-normal { z-index: 900; mix-blend-mode: soft-light; background: radial-gradient(circle 220px at var(--lx, 50%) var(--ly, 50%), rgba(255, 220, 180, 0.4) 0%, rgba(0,0,0,0.6) 70%); }
        #light-mask-uv { z-index: 900; mix-blend-mode: color-dodge; background: radial-gradient(circle 180px at var(--lx, 50%) var(--ly, 50%), rgba(80, 0, 255, 0.5) 0%, rgba(10, 0, 40, 0.8) 70%); }
        body.flash-on.mode-normal #light-mask-normal { opacity: 1; }
        body.flash-on.mode-uv #light-mask-uv { opacity: 1; }

        /* ================================= HUD ================================= */
        #hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; display: flex; flex-direction: column; justify-content: space-between; }
        .hud-header { background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); padding: 15px; text-align: center; }
        .hud-title { font-family: var(--font-type); color: var(--accent-gold); font-size: 1.6rem; margin: 0; letter-spacing: 2px; text-shadow: 0 2px 4px black; }
        .hud-footer { padding: 15px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); min-height: 120px; pointer-events: none !important;}
        
        #game-message { opacity: 0; color: #fff; font-family: var(--font-ui); font-size: 0.8rem; margin-bottom: 10px; transition: opacity 0.5s; text-align: center; background: rgba(0,0,0,0.8); padding: 6px 12px; border-radius: 20px; }

        #flashlight-ui { display: none; align-items: center; gap: 15px; background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 40px; border: 1px solid #333; pointer-events: auto;}
        .btn-flash-power {
            width: 60px; height: 60px; border-radius: 50%; background: #222; border: 3px solid #444; color: #555;
            font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: all 0.2s; position: relative;
        }
        .btn-flash-power.active { background: #ddd; color: #111; border-color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.5); }
        .btn-flash-power.active.uv-mode { background: var(--accent-uv); color: #fff; box-shadow: 0 0 25px var(--accent-uv); }
        
        #uv-secret-switch {
            position: absolute; bottom: 4px; right: 4px; width: 12px; height: 12px; background: #111;
            border-radius: 50%; border: 1px solid #333; background-image: linear-gradient(45deg, transparent 45%, #555 45%, #555 55%, transparent 55%); cursor: pointer; z-index: 10;
        }

        /* ================================= MODALES ================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.96); z-index: 3000;
            display: none; align-items: center; justify-content: center; flex-direction: column; perspective: 1500px;
        }
        .modal-overlay.open { display: flex; }

        .flip-wrapper { width: 90vw; max-width: 320px; aspect-ratio: 3/4; position: relative; transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; margin-bottom: 15px; }
        .flip-wrapper.flipped { transform: rotateY(180deg); }
        .flip-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; }
        .flip-back { transform: rotateY(180deg); }

        .modal-content-centered { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }

        .modal-buttons { display: flex; flex-direction: column; gap: 10px; width: 80%; max-width: 250px; z-index: 3005; pointer-events: auto; }
        .btn-modal { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: white; font-family: var(--font-ui); font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: background 0.2s; font-size: 0.9rem;}
        .btn-modal:active { background: #333; transform: scale(0.98); }
        .btn-flip { background: var(--ink-blue); border-color: #1a237e; display: none; }
        .btn-close { background: #c62828; border-color: #b71c1c; }

        .zoom-letter-container { background: #fff; padding: 20px; color: #111; font-family: var(--font-hand); font-size: 1.2rem; line-height: 1.3; transform: rotate(-1deg); width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: left; }
        .modal-cloned-item { position: relative !important; transform: scale(1.3) rotate(0deg) !important; top: auto !important; left: auto !important; margin: auto; }

        /* Digicode */
        #keypad-container { background: #1a1a1a; padding: 20px; border-radius: 15px; border: 2px solid #333; box-shadow: 0 20px 50px black; width: 90%; max-width: 300px; pointer-events: auto; }
        #keypad-screen { background: #000; color: #d32f2f; font-family: var(--font-tech); font-size: 2rem; text-align: center; padding: 12px; margin-bottom: 15px; border: 2px inset #333; letter-spacing: 6px; text-shadow: 0 0 10px rgba(211, 47, 47, 0.5); }
        .keypad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .key { height: 50px; background: #333; border: 1px solid #444; border-radius: 8px; color: #eee; font-family: var(--font-tech); font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 3px 0 #111; }
        .key:active { transform: translateY(3px); box-shadow: none; }
        .key-ok { background: #1b5e20; border-color: #2e7d32; }
        .key-clear { background: #b71c1c; border-color: #c62828; }
        .shake-error { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }

        /* SCREENS */
        .screen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #0a0a0a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; transition: opacity 0.8s ease-out; }
        .screen-overlay.hidden { opacity: 0; pointer-events: none; }
        .intro-folder { border: 2px solid #333; padding: 20px; max-width: 400px; background: #111; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .intro-title { font-family: var(--font-type); font-size: 2rem; color: var(--accent-gold); margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .intro-text { font-family: var(--font-type); font-size: 0.9rem; color: #ccc; line-height: 1.6; margin-bottom: 30px; text-align: left; }
        .btn-start { background: var(--accent-gold); color: #000; font-family: var(--font-ui); font-weight: 900; border: none; padding: 12px 25px; font-size: 1rem; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 0 20px rgba(255, 193, 7, 0.4); animation: pulse 2s infinite; }
        
        /* SUCCESS SCREEN - Z-INDEX 20000 POUR √äTRE SUR DE PASSER DEVANT LE COFFRE */
        #success-screen { background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 20000; }
        .success-content { border: 4px solid var(--accent-gold); padding: 40px; background: #000; box-shadow: 0 0 80px rgba(255, 193, 7, 0.3); transform: scale(0.8); opacity: 0; transition: all 0.5s ease-out; }
        #success-screen.visible .success-content { transform: scale(1); opacity: 1; }
        .success-title { font-family: var(--font-ui); font-weight: 900; font-size: 2.5rem; color: var(--accent-gold); margin-bottom: 10px; text-shadow: 0 0 20px var(--accent-gold); }
        .success-text { font-family: var(--font-ui); font-size: 1rem; color: #fff; margin-bottom: 30px; }
        .btn-next { background: transparent; border: 2px solid #fff; color: #fff; font-family: var(--font-ui); font-weight: bold; padding: 15px 40px; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s; }
        .btn-next:active { background: #fff; color: #000; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    </style>
</head>
<body>

    <div id="intro-screen" class="screen-overlay">
        <div class="intro-folder">
            <div class="intro-title">ENQU√äTE BOX (version wish)</div>
            <p style="color:var(--accent-gold); letter-spacing:3px; margin-bottom:20px;">L'√âNIGME DU PATRON</p>
            <div class="intro-text">
                MISSION :<br>
                La bouteille de "Comme d'hab" est verrouill√©e dans un coffre.<br>
                Analysez les indices sur la table pour trouver le code.<br><br>
                NOTE :<br>
                Certains indices sont invisibles √† l'≈ìil nu...
            </div>
            <button class="btn-start" onclick="startGame()">COMMENCER L'ENQU√äTE</button>
        </div>
    </div>

    <div id="success-screen" class="screen-overlay hidden">
        <div class="success-content">
            <div class="success-title">OUVERTURE</div>
            <div class="success-text" style="text-align:center;">BIEN JOU√â LES PILIERS.<br>LA BOUTEILLE EST √Ä VOUS.</div>
            <button class="btn-next" onclick="goToNext()">SUITE : LE D√âFI LOGIQUE >></button>
        </div>
    </div>

    <div id="hud-layer">
        <div class="hud-header"><h1 class="hud-title">L'√âNIGME DU PATRON</h1></div>
        <div class="hud-footer">
            <div id="game-message"></div>
            <div id="flashlight-ui">
                <div class="btn-flash-power" id="flash-btn" onclick="Engine.togglePower()">
                    üí°
                    <div id="uv-secret-switch" onclick="Engine.toggleUV(event)"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="light-mask-normal"></div>
    <div id="light-mask-uv"></div>

    <div id="game-stage">
        <div id="stage-overlay"></div>

        <div class="table-item item-letter" style="top:12%; left:5%;" onclick="Engine.inspect('letter')">
            <div class="letter-blur">
                Salut les Piliers. Bon courage pour le code.<br><br>
                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. 
                Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
            </div>
        </div>

        <div class="table-item item-receipt" style="top:38%; left:8%;" onclick="Engine.inspect('receipt')">
            <div class="receipt-header">LE SAINT FOY'S<br>CLUNY 71250<br><span style="font-size:0.45rem">Srv: Adanars 108</span></div>
            <div style="border-bottom:1px dashed #aaa; margin-bottom:5px;"></div>
            <div class="receipt-body">
                <div class="receipt-row"><span>2 Pinte "Comme d'hab"</span><span class="hidden-price">??.??‚Ç¨</span></div>
                <div class="receipt-row"><span>1 Saucisson Sec</span><span class="hidden-price">??.??‚Ç¨</span></div>
                <div class="receipt-row"><span>1 Cacahu√®tes</span><span>OFFERT</span></div>
            </div>
            <div style="border-bottom:1px dashed #aaa; margin-top:12px;"></div>
            <div class="receipt-total"><span>TOTAL</span><span class="hidden-price">??.??‚Ç¨</span></div>
            <div class="receipt-stain"></div>
        </div>

        <div class="table-item item-photo" style="top:12%; left:65%;" onclick="Engine.inspect('photo')">
            <div class="photo-inner"><img src="Temps/sam&anthe.jpg" alt="Photo"></div>
            <div class="photo-text">30 Janvier ‚ù§Ô∏è</div>
        </div>

        <div class="table-item item-coaster" style="top:40%; left:65%;" onclick="Engine.inspect('coaster')">
            <div class="coaster-logo"><b>SAINT FOY'S</b><br>BAR</div>
        </div>

        <div class="table-item item-menu uv-revealable" style="top:65%; left:60%;" onclick="Engine.inspect('menu')">
            <div class="menu-title">CARTE</div>
            <div class="menu-list">
                <div class="menu-item"><span>Pinte Blonde (50cl)</span><span>8 ‚Ç¨</span></div>
                <div class="menu-item"><span>Demi (25cl)</span><span>4 ‚Ç¨</span></div>
                <div class="menu-item"><span>Pinte IPA</span><span>9 ‚Ç¨</span></div>
                <div class="menu-item"><span>Saucisson</span><span>6 ‚Ç¨</span></div>
                <div class="menu-item"><span>Planche Mixte</span><span>15 ‚Ç¨</span></div>
            </div>
            <div class="uv-hidden-layer" style="align-items: flex-end; padding-bottom: 10px;">
                <div class="uv-text-style" style="font-size:0.9rem; transform:rotate(-3deg); width:100%;">TARIF PILIERS :<br>PINTE = 4.90 ‚Ç¨</div>
            </div>
        </div>

        <div class="table-item" id="item-safe" style="top:85%; left:20%; transform: translate(-50%, -50%);">
            <div class="safe-body">
                <div class="safe-interior"><div class="safe-bottle">üç∫</div></div>
                <div class="safe-door">
                    <div class="safe-dial"></div>
                    <div class="safe-handle"></div>
                </div>
            </div>
        </div>

        <div class="table-item" id="item-flashlight" style="top:85%; left:20%; transform: translate(-50%, -50%) rotate(10deg);" onclick="Engine.pickupFlashlight(event)">
            <div class="flash-head"></div><div class="flash-body"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-inspect">
        <div class="flip-wrapper" id="zoom-flipper">
            <div class="flip-face" id="zoom-front"></div>
            <div class="flip-face flip-back" id="zoom-back"></div>
        </div>
        <div class="modal-buttons">
            <button class="btn-modal btn-close" onclick="Engine.closeModals()">POSER L'OBJET</button>
            <button class="btn-modal btn-flip" id="btn-flip-card" onclick="Engine.flipCard()">RETOURNER ‚Üª</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-keypad">
        <div id="keypad-container">
             <div style="color:#aaa; font-family:var(--font-type); text-align:center; margin-bottom:15px;">S√âCURIT√â</div>
             <div id="keypad-screen">_ _ _ _</div>
             <div class="keypad-grid">
                <div class="key" onclick="Keypad.press(1)">1</div><div class="key" onclick="Keypad.press(2)">2</div><div class="key" onclick="Keypad.press(3)">3</div>
                <div class="key" onclick="Keypad.press(4)">4</div><div class="key" onclick="Keypad.press(5)">5</div><div class="key" onclick="Keypad.press(6)">6</div>
                <div class="key" onclick="Keypad.press(7)">7</div><div class="key" onclick="Keypad.press(8)">8</div><div class="key" onclick="Keypad.press(9)">9</div>
                <div class="key key-clear" onclick="Keypad.clear()">C</div><div class="key" onclick="Keypad.press(0)">0</div><div class="key key-ok" onclick="Keypad.check()">OK</div>
            </div>
            <button class="btn-modal btn-close" style="width:100%; margin-top:15px;" onclick="Engine.closeModals()">RETOUR</button>
        </div>
    </div>

<script>
        function startGame() { document.getElementById('intro-screen').classList.add('hidden'); Engine.init(); }
        function goToNext() { window.location.href = "apero4.html"; }

        const Engine = {
            state: { 
                hasFlashlight: false, isFlashOn: false, isUV: false, 
                // Dragging Variables
                dragItem: null,
                initialX: 0,
                initialY: 0,
                currentX: 0,
                currentY: 0,
                xOffset: 0,
                yOffset: 0,
                isDragging: false
            },
            
            init: function() {
                // Tracking lumi√®re
                ['mousemove', 'touchmove'].forEach(e => document.addEventListener(e, this.trackLight.bind(this), {passive:false}));
                
                // STABILISATION DU COFFRE (Conversion % -> Pixels Fixes)
                const safe = document.getElementById('item-safe');
                const rect = safe.getBoundingClientRect();
                
                // On fixe la position pour √©viter le saut lors du premier drag
                // On utilise transform pour le mouvement (plus fluide)
                safe.style.top = rect.top + 'px';
                safe.style.left = rect.left + 'px';
                safe.style.transform = "none"; // On retire le centrage CSS, maintenant qu'on a les pixels
                
                // Initialisation de la position pour le script
                this.state.xOffset = 0;
                this.state.yOffset = 0;
                this.state.initialX = rect.left;
                this.state.initialY = rect.top;

                // ATTACHEMENT DES EVENTS DRAG (Pointer Events = Souris + Touch)
                safe.addEventListener("pointerdown", this.dragStart.bind(this));
                window.addEventListener("pointerup", this.dragEnd.bind(this));
                window.addEventListener("pointermove", this.drag.bind(this));

                setInterval(this.checkUV.bind(this), 100);
            },

            // --- NOUVEAU MOTEUR DRAG FLUIDE ---
            dragStart: function(e) {
                if (e.target.closest('#item-safe')) {
                    this.state.initialX = e.clientX - this.state.xOffset;
                    this.state.initialY = e.clientY - this.state.yOffset;
                    this.state.dragItem = e.target.closest('#item-safe');
                    
                    // Capture le pointeur pour √©viter de perdre l'objet si on bouge vite
                    this.state.dragItem.setPointerCapture(e.pointerId);
                    this.state.isDragging = false; // On commence par supposer un clic
                }
            },

            drag: function(e) {
                if (this.state.dragItem) {
                    e.preventDefault();

                    this.state.currentX = e.clientX - this.state.initialX;
                    this.state.currentY = e.clientY - this.state.initialY;

                    // Si on bouge de plus de 5 pixels, c'est un drag
                    if(Math.abs(this.state.currentX) > 5 || Math.abs(this.state.currentY) > 5) {
                        this.state.isDragging = true;
                    }

                    if(this.state.isDragging) {
                        this.state.xOffset = this.state.currentX;
                        this.state.yOffset = this.state.currentY;
                        this.setTranslate(this.state.currentX, this.state.currentY, this.state.dragItem);
                    }
                }
            },

            dragEnd: function(e) {
                if(!this.state.dragItem) return;

                this.state.initialX = this.state.currentX;
                this.state.initialY = this.state.currentY;
                
                // Si on a √† peine boug√©, c'est un clic -> Ouvrir clavier
                if(!this.state.isDragging) {
                    this.openKeypad();
                }

                this.state.dragItem = null;
                this.state.isDragging = false;
            },

            setTranslate: function(xPos, yPos, el) {
                el.style.transform = "translate3d(" + xPos + "px, " + yPos + "px, 0)";
            },
            // ------------------------------------

            showMessage: function(msg) {
                const el = document.getElementById('game-message');
                el.innerText = msg; el.style.opacity = 1;
                setTimeout(() => el.style.opacity = 0, 3000);
            },

            pickupFlashlight: function(e) {
                if(e) e.stopPropagation(); 
                document.getElementById('item-flashlight').style.display = 'none';
                document.getElementById('flashlight-ui').style.display = 'flex';
                this.state.hasFlashlight = true;
                this.showMessage("Vous avez ramass√© une lampe torche");
            },
            togglePower: function() {
                if(!this.state.hasFlashlight) return;
                this.state.isFlashOn = !this.state.isFlashOn;
                this.updateLightUI();
            },
            toggleUV: function(e) {
                if(e) e.stopPropagation();
                this.state.isUV = !this.state.isUV;
                this.updateLightUI();
            },
            updateLightUI: function() {
                const body = document.body; const btn = document.getElementById('flash-btn');
                body.classList.remove('flash-on', 'mode-normal', 'mode-uv'); btn.classList.remove('active', 'uv-mode');
                if(this.state.isFlashOn) {
                    body.classList.add('flash-on'); btn.classList.add('active');
                    this.state.isUV ? (body.classList.add('mode-uv'), btn.classList.add('uv-mode')) : body.classList.add('mode-normal');
                }
            },
            trackLight: function(e) {
                if(!this.state.isFlashOn) return;
                const x = e.touches ? e.touches[0].clientX : e.clientX; const y = e.touches ? e.touches[0].clientY : e.clientY;
                document.body.style.setProperty('--lx', x + 'px'); document.body.style.setProperty('--ly', y + 'px');
                this.state.lightPos = {x, y};
            },
            checkUV: function() {
                if(!this.state.isFlashOn || !this.state.isUV) { document.querySelectorAll('.uv-revealable').forEach(el => el.classList.remove('is-lit')); return; }
                document.querySelectorAll('.uv-revealable').forEach(item => {
                    const r = item.getBoundingClientRect(); const lx = this.state.lightPos.x, ly = this.state.lightPos.y; const m = 15;
                    (lx > r.left+m && lx < r.right-m && ly > r.top+m && ly < r.bottom-m) ? item.classList.add('is-lit') : item.classList.remove('is-lit');
                });
            },

            inspect: function(id) {
                if(this.state.isDragging) return; // S√©curit√© anti-clic pendant drag
                
                const modal = document.getElementById('modal-inspect');
                const flipper = document.getElementById('zoom-flipper');
                const front = document.getElementById('zoom-front');
                const back = document.getElementById('zoom-back');
                const btnFlip = document.getElementById('btn-flip-card');
                
                flipper.classList.remove('flipped'); front.innerHTML=''; back.innerHTML=''; btnFlip.style.display='none';

                switch(id) {
                    case 'letter':
                        front.innerHTML = `
                        <div class="modal-content-centered">
                            <div class="zoom-letter-container">
                                <p><b>Salut les Piliers,</b></p>
                                <p>Comme promis, j'ai mis votre bouteille dans le coffre pour pas qu'on vous la pique.</p>
                                <p>Le code ? C'est simple logique. C'est une histoire de <b>prix</b> et de <b>dates</b>...</p>
                                <p><i>PS: N'oubliez pas votre privil√®ge...</i></p>
                                <p style="text-align:right; margin-top:30px;">- Le Patron</p>
                            </div>
                        </div>`; 
                        break;
                    case 'receipt':
                        const r = document.querySelector('.item-receipt').cloneNode(true);
                        r.classList.add('modal-cloned-item'); 
                        front.innerHTML = ''; const cw = document.createElement('div'); cw.className='modal-content-centered'; cw.appendChild(r); front.appendChild(cw);
                        break;
                    case 'menu':
                        const m = document.querySelector('.item-menu').cloneNode(true);
                        m.classList.add('modal-cloned-item'); 
                        front.innerHTML = ''; const cm = document.createElement('div'); cm.className='modal-content-centered'; cm.appendChild(m); front.appendChild(cm);
                        break;
                    case 'photo':
                        btnFlip.style.display='block';
                        front.innerHTML = `<div class="modal-content-centered"><div style="background:#fff; padding:12px 12px 40px 12px; box-shadow:0 10px 30px rgba(0,0,0,0.5);"><div style="background:#000; width:220px; height:220px; overflow:hidden;"><img src="Temps/sam&anthe.jpg" style="width:100%; height:100%; object-fit:cover; filter:sepia(0.3);"></div><div style="font-family:var(--font-hand); font-size:1.8rem; margin-top:12px; text-align:center; color:#222; font-weight:bold;">30 Janvier ‚ù§Ô∏è</div></div></div>`;
                        back.innerHTML = `<div class="modal-content-centered"><div style="width:240px; height:280px; background:#e0e0e0; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(0,0,0,0.5);"><div style="font-family:var(--font-hand); font-size:3.5rem; color:#333; transform:rotate(-5deg);">Table N¬∞59</div></div></div>`; break;
                    case 'coaster':
                        btnFlip.style.display='block';
                        front.innerHTML = `<div class="modal-content-centered"><div style="width:220px; height:220px; border-radius:50%; background:#d7ccc8; border:8px solid #5d4037; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(0,0,0,0.5); background-image:var(--cardboard-texture);"><div style="text-align:center; font-family:var(--font-type); font-size:1.8rem; color:#5d4037; font-weight:bold;">SAINT FOY'S<br>BAR</div></div></div>`;
                        back.innerHTML = `<div class="modal-content-centered"><div class="uv-revealable" style="width:220px; height:220px; border-radius:50%; background:#bcaaa4; border:8px solid #5d4037; display:flex; align-items:center; justify-content:center; background-image:var(--cardboard-texture); position:relative; overflow:hidden;"><div class="uv-hidden-layer"><div class="uv-text-style" style="font-size:0.8rem; border:3px dashed var(--text-uv); padding:15px; border-radius:50%; transform:rotate(-5deg);">( PRIX BI√àRES + TABLE )<br>x JOUR</div></div><div style="font-size:0.7rem; color:#666; position:absolute; bottom:30px;">(Dos du sous-bock)</div></div></div>`; break;
                }
                modal.classList.add('open');
            },
            flipCard: function() { document.getElementById('zoom-flipper').classList.toggle('flipped'); },
            closeModals: function() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open')); },
            openKeypad: function() { document.getElementById('modal-keypad').classList.add('open'); Keypad.clear(); }
        };

        const Keypad = {
            code: "", solution: "2064",
            press: function(n) { if(this.code.length<4) { this.code+=n; this.update(); if(navigator.vibrate) navigator.vibrate(20); } },
            clear: function() { this.code=""; this.update(); if(navigator.vibrate) navigator.vibrate(50); },
            update: function() { document.getElementById('keypad-screen').innerText = this.code.padEnd(4,'_').split('').join(' '); },
            check: function() {
                const s = document.getElementById('keypad-screen');
                if(this.code === this.solution) {
                    s.style.color='#66bb6a'; s.innerText="OPEN"; if(navigator.vibrate) navigator.vibrate([100,50,200]);
                    Engine.closeModals(); 
                    document.getElementById('item-safe').classList.add('move-center');
                    
                    setTimeout(() => {
                        document.getElementById('item-safe').classList.add('open-anim');
                        setTimeout(() => {
                            document.getElementById('success-screen').classList.remove('hidden');
                            document.getElementById('success-screen').classList.add('visible');
                        }, 2500);
                    }, 1200);
                } else {
                    s.innerText="ERR"; document.getElementById('keypad-container').classList.add('shake-error');
                    if(navigator.vibrate) navigator.vibrate(400);
                    setTimeout(() => { document.getElementById('keypad-container').classList.remove('shake-error'); this.clear(); s.style.color='#d32f2f';}, 600);
                }
            }
        };
        // Init lanc√© par bouton start
    </script>
</body>
</html>